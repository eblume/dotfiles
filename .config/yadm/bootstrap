#!/bin/sh

set -o xtrace
set -o nounset
set -o errexit

### TO USE: `yadm bootstrap` - fully idempotent and intended to be run often to get upgrades, etc.
# To bootstrap from 0, you must first install yadm.
# https://yadm.io/docs/install
# On Mac OS, the typical process is:
#  1. /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
#  2. brew install yadm
#  3. yadm clone <DOTFILES REPO HERE>
#  4. yadm bootstrap
#
# (on non-Mac OS, you just need to replace steps 1 and 2 with whatever gives you a working 'yadm'.)

system_type=$(uname -s)

### Install homebrew and .Brewfile, to begin bootstrapping

if [ "$system_type" = "Darwin" ]; then
    # install homebrew if it's missing
    if ! command -v brew >/dev/null 2>&1; then
        # Installing homebrew
        /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    fi

    if [ -f "$HOME/.Brewfile" ]; then
        # Updating homebrew bundle
        brew bundle --global
    fi

    # Upgrading all installed brew packages
    # NOTE: This is something I'm trying out, I may want to disable this later. It might be better to stick with
    # only the `brew bundle --global` above, which does do updates after all.
    brew update
    brew upgrade

fi

### Install asdf versions (asdf itself hopefully installed above)
if
    ! command -v asdf >/dev/null
then
    echo "asdf not found, bootstrapping failed - maybe bootstrapping needs to be added to your system: $system_type"
    echo "see ~/.config/yadm/bootstrap"
    exit 1
else
    # The "|| true"'s here are because of the errexit set above, which these plugins will hit. oh well.
    asdf plugin add python || true
    asdf plugin add kustomize || true
    asdf plugin add nodejs || true
    asdf plugin add golang || true
    asdf plugin add kubectl https://github.com/asdf-community/asdf-kubectl.git || true
    asdf plugin add kubectx https://github.com/virtualstaticvoid/asdf-kubectx.git || true
    asdf plugin add cmctl https://github.com/asdf-community/asdf-cmctl.git || true
    asdf plugin update --all
    asdf install # (this targets `.tool-versions`, which is linked by yadm)
fi

### Bootstrap sumbodules
# (at time of writing, not used, but could be used some day and shouldn't hurt?)
yadm submodule update --recursive --init

### Bootstrap neovim packer.nvim
# (This will fail if packer hasn't yet bootstrqpped; in which case, just run 'nvim' once and then bootstrap again)
nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'

### Install global npm packages
npm install -g npm
npm install -g yaml-language-server
npm install -g cspell
npm install -g bash-language-server
npm install -g pyright
# Finally, do a global update, because I like to live dangerously
npm update -g
asdf reshim nodejs

### Install global python packages
pip install --upgrade pip
pip install --upgrade yamlfix
pip install --upgrade bashate
asdf reshim python

### Install global golang packages
go install github.com/rhysd/actionlint/cmd/actionlint@latest
asdf reshim golang

### FIN
echo "Bootstrapping complete"
